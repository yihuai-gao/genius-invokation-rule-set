# 整理中内容

https://docs.qq.com/doc/DZHhJVm1FRERIdk9q

## *执行效果(调用者, 效果描述)*

- *伤害事件队列* $\gets []$；
- *非伤害事件队列* $\gets []$；
- 按 *效果描述* 执行。其中：
  - 描述中含 *造成伤害*，则：
    - *伤害* $\gets$ *伤害结算(伤害描述)*；
    - 造成 *伤害*；
    - *入队(伤害事件队列, 伤害)*；
  - 描述中含（非 *造成伤害* 的）*事件*，则：
    - 按 *描述* 执行；
    - *入队(非伤害事件队列, 描述)*；
- *免于被击倒角色* $\gets []$；
- *被击倒角色* $\gets []$；
- 对于 *伤害事件* 中的每个 *事件*：
  - 若 *事件.可击倒*：
    - 若 *免于被击倒(事件.目标角色)* 且 *事件.目标角色* $\notin$ *免于被击倒角色*：
      - *入队(免于被击倒角色, 事件.目标角色)*；
      - *事件.可击倒* $\gets$ `false`；
    - 否则：
      - *入队(被击倒角色, 事件.目标角色)*；
- *纯伤害事件队列* $\gets$ *筛选*(*伤害事件*, $\neg$ *事件.可击倒*)；
- *击倒事件队列* $\gets$ *筛选*(*伤害事件*, *事件.可击倒*)；
- 对于 *免于被击倒角色* 中的每个 *角色*：
  - *(调用者, 描述)* $\gets$ *免于被击倒描述(角色)*；
  - *执行效果(调用者, 描述)*；
  - *治疗值* $\gets$ *免于被击倒治疗值(描述)*；
  - *复苏事件* $\gets$ *构造事件("damageOrHeal", { type: HEAL, value: 治疗值 })*；
  - *结算事件*([*复苏事件*])；
- 若 *产出充能(效果描述)*：
  - *增加充能(调用者)*；
- *结算事件(非伤害事件队列)*；
- *结算事件(纯伤害事件队列)*;
- *结算事件(击倒事件队列)*；
- 对于 *被击倒角色* 中的每个 *角色*：
  - 若 *角色* $\in$ *全部在场角色()*：
    - *击倒(角色)*；
    - *角色状态和装备* $\gets$ *角色区实体(角色)*；
    - *弃置(角色装备和状态)*
    - 若 *是出战角色(角色)*：
      - *添加异步事件(选择出战角色(角色.阵营))*
- *切换角色事件队列* $\gets$ *等待异步事件()*；
- *结算事件(切换角色事件队列)*。

## *结算事件(事件队列)*

- 对于 *事件队列* 中的每个 *事件*：
  - *待响应实体* $\gets$ *获取全部实体(事件.发生时对局状态)*
  - 若 *事件.类型* $=$ `"damageOrHeal"` 且 *事件.可击倒*：
    - *待响应实体* $\gets$ *排序(待响应实体, 击倒事件优先级(事件.目标角色))*；
  - 对于 *待响应实体* 中的每个 *实体*：
    - *效果* $\gets$ *响应事件(事件)*：
    - 若 *效果* $\neq$ `null`：
      - 若 *实体* $\in$ *获取全部实体()* 或 *事件.类型* $=$ `"onDispose"`：
        - *执行效果(实体, 效果)*；

## *击倒事件优先级(目标角色)(实体)*

- 若 *目标角色* $=$ *实体*，返回 $1$；
- 否则，若 *实体* $\in$ *角色区实体(目标角色)*，返回 $1$；
- 否则，返回 $0$。

<script>
import "katex/dist/katex.min.css"
</script>
